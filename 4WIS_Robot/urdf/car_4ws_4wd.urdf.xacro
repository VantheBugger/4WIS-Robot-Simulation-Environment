<?xml version="1.0" encoding="utf-8"?>
<robot name="$(arg robot_name)" xmlns:xacro="http://wiki.ros.org/xacro">

  <gazebo>
    <disableFixedJointLumping>true</disableFixedJointLumping>
  </gazebo>
  <xacro:include filename="$(find 4WIS_Robot)/urdf/sensors/lidar_mount.xacro"/>
  <xacro:include filename="$(find 4WIS_Robot)/urdf/sensors/lidar_gpu_ray.xacro"/>
  <xacro:include filename="$(find 4WIS_Robot)/urdf/sensors/imu_mount.xacro"/>
  <xacro:include filename="$(find 4WIS_Robot)/urdf/sensors/imu_sensor_gazebo.xacro"/>
  <xacro:include filename="$(find 4WIS_Robot)/urdf/sensors/camera_mount.xacro"/>
  <xacro:include filename="$(find 4WIS_Robot)/urdf/sensors/camera_sensor_gazebo.xacro"/>


  <xacro:property name="PI" value="3.1415926535897931"/>
  <xacro:property name="mesh_path" value="package://4WIS_Robot/meshes"/>
  
  <xacro:property name="wheel_offset_x" value="0.32" /> <xacro:property name="wheel_offset_y" value="0.235" /> <xacro:property name="steer_limit" value="0.55" />
  
  <!-- <link name="base"/>
  <joint name="base_joint" type="fixed">
    <parent link="base"/>
    <child link="base_link"/>
    <origin xyz="0 0 0.3" rpy="0 0 0"/>
  </joint> -->


  <link name="base_link">
    <inertial>
      <origin xyz="-0.00117586528514695 -4.30552833609457E-17 0.05" rpy="0 0 0" />
      <mass value="20.2533565247656" />
      <inertia ixx="1.311634309655" ixy="1.64735322115376E-16" ixz="0.0137789561118299"
               iyy="3.43401128074704" iyz="-1.3755764102141E-16" izz="3.79965514788602" />
    </inertial>
    <visual>
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}/base_link.STL" />
      </geometry>
      <material name="">
        <color rgba="0.392156862745098 0.384313725490196 1 1" />
      </material>
    </visual>
    <collision >
      <origin xyz="0 0 0" rpy="0 0 0" />
      <geometry>
        <mesh filename="${mesh_path}/base_link.STL" />
      </geometry>
    </collision>
  </link>

  <gazebo reference="base_link">
    <material>Gazebo/Blue</material>
  </gazebo>
  
  <xacro:macro name="wheel_assembly" params="prefix x_pos y_pos">
    
    <link name="${prefix}_steer_link">
      <inertial>
        <origin xyz="5.5511E-17 0 -0.088728" rpy="0 0 0" />
        <mass value="25" />
        <inertia ixx="0.047904" ixy="0" ixz="0" iyy="0.037562" iyz="0" izz="0.014192" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="${mesh_path}/${prefix}_steer_link.STL" />
        </geometry>
        <material name="">
          <color rgba="1 0.96078 0.90588 1" />
        </material>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="${mesh_path}/${prefix}_steer_link.STL" />
        </geometry>
      </collision>
    </link>
  
    <joint name="${prefix}_steer_joint" type="revolute">
      <origin xyz="${x_pos} ${y_pos} -0.01" rpy="0 0 0" />
      <parent link="base_link" />
      <child link="${prefix}_steer_link" />
      <axis xyz="0 0 1" />
      <limit lower="-${steer_limit}" upper="${steer_limit}" effort="100" velocity="1" />
    </joint>

    <link name="${prefix}_drive_link">
      <inertial>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <mass value="2.1666" />
        <inertia ixx="0.010578" ixy="0" ixz="0" iyy="0.010578" iyz="0" izz="0.020276" />
      </inertial>
      <visual>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="${mesh_path}/${prefix}_drive_link.STL" />
        </geometry>
        <material name="">
          <color rgba="0 0 0 1" />
        </material>
      </visual>
      <collision>
        <origin xyz="0 0 0" rpy="0 0 0" />
        <geometry>
          <mesh filename="${mesh_path}/${prefix}_drive_link.STL" />
        </geometry>
      </collision>
    </link>

    <joint name="${prefix}_drive_joint" type="continuous">
      <origin xyz="0 0 -0.16" rpy="${PI/2} 0 0" />
      <parent link="${prefix}_steer_link" />
      <child link="${prefix}_drive_link" />
      <axis xyz="0 0 -1" />
    </joint>

    <gazebo reference="${prefix}_drive_link">
      <mu1>1.5</mu1>
      <mu2>1.5</mu2>
      <kp>100000.0</kp>
      <kd>10000.0</kd>
      <minDepth>0.001</minDepth>
      <maxVel>5.0</maxVel>
      <material>Gazebo/Black</material>
    </gazebo>

    <transmission name="${prefix}_steer_trans">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="${prefix}_steer_joint">
        <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
      </joint>
      <actuator name="${prefix}_steer_motor">
        <mechanicalReduction>1</mechanicalReduction>
        <hardwareInterface>hardware_interface/PositionJointInterface</hardwareInterface>
      </actuator>
    </transmission>

    <transmission name="${prefix}_drive_trans">
      <type>transmission_interface/SimpleTransmission</type>
      <joint name="${prefix}_drive_joint">
        <hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
      </joint>
      <actuator name="${prefix}_drive_motor">
        <mechanicalReduction>1</mechanicalReduction>
        <hardwareInterface>hardware_interface/VelocityJointInterface</hardwareInterface>
      </actuator>
    </transmission>
  </xacro:macro>

  <xacro:wheel_assembly prefix="fl" x_pos="${wheel_offset_x}"  y_pos="${wheel_offset_y}" />
  <xacro:wheel_assembly prefix="fr" x_pos="${wheel_offset_x}"  y_pos="-${wheel_offset_y}" />
  <xacro:wheel_assembly prefix="rl" x_pos="-${wheel_offset_x}" y_pos="${wheel_offset_y}" />
  <xacro:wheel_assembly prefix="rr" x_pos="-${wheel_offset_x}" y_pos="-${wheel_offset_y}" />



  <!-- <xacro:lidar_mount parent="base_link" prefix="lidar" xyz="0.36 0 0.485" rpy="0 0 0"/>
  <xacro:lidar_gpu_ray reference="lidar_link" prefix="lidar" topic="velodyne_points" frame="lidar_link"/> -->


  <xacro:VLP-16 parent="base_link" name="lidar_link" topic="velodyne_points" organize_cloud="false" hz="40" collision_range="0.1" samples="440" gpu="true" min_range="0.01">
        <origin xyz="0.36 0 0.485" rpy="0 0 0" />
  </xacro:VLP-16>

  <xacro:imu_mount parent="base_link" prefix="imu" xyz="0.36 0 0.555" rpy="0 0 0"/>
  <xacro:imu_sensor_gazebo reference="imu_link" prefix="imu" topic="imu" frame="$(arg robot_name)/imu_link"/>
  <xacro:camera_mount parent="base_link" prefix="camera" xyz="0.36 0 0.555" rpy="0 0 0"/>
  <xacro:camera_sensor_gazebo reference="camera_link" camera_name="/camera" image_topic="image_raw"
                              info_topic="camera_info" frame="$(arg robot_name)/camera_link"/>

  <gazebo>
    <plugin name="gazebo_ros_control" filename="libgazebo_ros_control.so">
      <robotNamespace>/$(arg robot_name)</robotNamespace>
    </plugin>
  </gazebo>

  <gazebo reference="base_link">
    <sensor name="base_collision_sensor" type="contact">
      <always_on>true</always_on>
      <update_rate>100.0</update_rate>
      <contact>
        <!-- 尝试这几种碰撞名称格式 -->
        <collision>base_link_collision</collision>
      </contact>
      <plugin name="base_bumper_controller" filename="libgazebo_ros_bumper.so">
        <bumperTopicName>/$(arg robot_name)/collision_states</bumperTopicName>
        <frameName>base_link</frameName>
      </plugin>
    </sensor>
  </gazebo>

</robot>



